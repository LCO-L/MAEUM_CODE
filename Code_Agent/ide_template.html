<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAEUM_CODE IDE</title>

    <!-- Markdown-it (Markdown) - ë¡œì»¬, Monaco loader ì „ì— ë¡œë“œí•´ì•¼ AMD ì¶©ëŒ ë°©ì§€ -->
    <script src="/static/js/markdown-it.min.js"></script>

    <!-- Highlight.js - ë¡œì»¬ -->
    <link rel="stylesheet" href="/static/css/github-dark.min.css">
    <script src="/static/js/highlight.min.js"></script>

    <!-- Monaco Editor (ë¡œì»¬) - AMD loaderì´ë¯€ë¡œ ë‹¤ë¥¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ í›„ì— ë¡œë“œ -->
    <script src="/static/monaco/min/vs/loader.js"></script>

    <style>
        :root {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d30;
            --bg-hover: #3c3c3c;
            --text-primary: #cccccc;
            --text-secondary: #969696;
            --text-highlight: #ffffff;
            --accent: #0078d4;
            --accent-hover: #1a8cff;
            --border: #3c3c3c;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
            --sidebar-width: 280px;
            --panel-height: 350px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .container { display: flex; height: 100vh; }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-header h1 { font-size: 14px; font-weight: 600; color: var(--text-highlight); }
        .sidebar-header .logo { font-size: 20px; }

        .file-explorer { flex: 1; overflow-y: auto; padding: 8px 0; }

        .file-item {
            padding: 6px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-primary);
            user-select: none;
        }

        .file-item:hover { background: var(--bg-hover); }
        .file-item.active { background: var(--accent); color: white; }
        .file-item.directory { font-weight: 500; }
        .file-item .icon { width: 16px; text-align: center; }
        .file-item .name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .toolbar {
            display: flex;
            gap: 4px;
            padding: 4px 8px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .toolbar button {
            padding: 4px 8px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
        }

        .toolbar button:hover { background: var(--bg-hover); }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            flex-shrink: 0;
        }

        .tab {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            cursor: pointer;
            border-right: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .tab.active { background: var(--bg-primary); color: var(--text-highlight); }
        .tab:hover { background: var(--bg-hover); }
        .tab .close { opacity: 0; font-size: 16px; padding: 2px; border-radius: 3px; }
        .tab:hover .close { opacity: 1; }
        .tab .close:hover { background: var(--bg-hover); }
        .tab.modified .name::after { content: ' â€¢'; color: var(--accent); }

        /* Editor Container */
        .editor-container { flex: 1; display: flex; flex-direction: column; min-height: 0; }
        #editor { flex: 1; min-height: 0; }

        /* Welcome Screen */
        .welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
        }
        .welcome h2 { font-size: 24px; margin-bottom: 16px; color: var(--text-primary); }
        .welcome p { margin-bottom: 8px; }
        .welcome kbd { background: var(--bg-tertiary); padding: 2px 6px; border-radius: 3px; font-size: 12px; }

        /* Resize Handle */
        .resize-handle { height: 4px; background: var(--border); cursor: ns-resize; }
        .resize-handle:hover { background: var(--accent); }

        /* Bottom Panel - Claude Code Style */
        .bottom-panel {
            height: var(--panel-height);
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .panel-tabs {
            display: flex;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
        }

        .panel-tab {
            padding: 8px 16px;
            font-size: 12px;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .panel-tab.active { color: var(--text-highlight); border-bottom-color: var(--accent); }
        .panel-tab:hover { color: var(--text-primary); }
        .panel-tab .badge {
            background: var(--accent);
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
        }

        .panel-content { flex: 1; overflow-y: auto; display: flex; }

        /* Split Panel: TodoList (Left) + Chat (Right) */
        .panel-split {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* TodoList Panel */
        .todo-panel {
            width: 300px;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .todo-header {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .todo-progress {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .todo-progress-bar {
            width: 60px;
            height: 4px;
            background: var(--bg-hover);
            border-radius: 2px;
            overflow: hidden;
        }

        .todo-progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s;
        }

        .todo-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .todo-item {
            padding: 8px 12px;
            margin-bottom: 4px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            border-left: 3px solid var(--border);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .todo-item.pending { border-left-color: var(--text-secondary); opacity: 0.7; }
        .todo-item.in_progress { border-left-color: var(--accent); background: rgba(0, 120, 212, 0.1); }
        .todo-item.completed { border-left-color: var(--success); opacity: 0.6; }
        .todo-item.completed .todo-text { text-decoration: line-through; }

        .todo-status {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            flex-shrink: 0;
        }

        .todo-item.pending .todo-status { border: 2px solid var(--text-secondary); }
        .todo-item.in_progress .todo-status { background: var(--accent); animation: pulse 1.5s infinite; }
        .todo-item.completed .todo-status { background: var(--success); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .todo-text { flex: 1; }
        .todo-action {
            padding: 2px 8px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .todo-item:hover .todo-action { opacity: 1; }

        /* Chat Panel */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 12px;
            max-width: 100%;
            box-sizing: border-box;
        }

        .chat-message {
            margin-bottom: 12px;
            font-size: 13px;
            line-height: 1.6;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            max-width: 100%;
        }

        .chat-message.user {
            background: var(--accent);
            color: white;
            padding: 10px 14px;
            border-radius: 16px 16px 4px 16px;
            margin-left: 20%;
            word-wrap: break-word;
            word-break: break-word;
        }

        .chat-message.assistant {
            background: var(--bg-tertiary);
            padding: 10px 14px;
            border-radius: 16px 16px 16px 4px;
            margin-right: 10%;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .chat-message.assistant pre {
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
            position: relative;
            border: 1px solid var(--border);
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-all;
            max-width: 100%;
        }

        .chat-message.assistant code {
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 12px;
        }

        /* ì¸ë¼ì¸ ì½”ë“œ */
        .chat-message.assistant p code,
        .chat-message.assistant li code {
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid var(--border);
        }

        /* ë§ˆí¬ë‹¤ìš´ ë¦¬ìŠ¤íŠ¸ */
        .chat-message.assistant ul,
        .chat-message.assistant ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .chat-message.assistant li {
            margin: 4px 0;
        }

        /* ë§ˆí¬ë‹¤ìš´ í—¤ë” */
        .chat-message.assistant h1,
        .chat-message.assistant h2,
        .chat-message.assistant h3 {
            margin: 12px 0 8px 0;
            color: var(--text-highlight);
        }

        .chat-message.assistant h1 { font-size: 18px; }
        .chat-message.assistant h2 { font-size: 16px; }
        .chat-message.assistant h3 { font-size: 14px; }

        /* ë§ˆí¬ë‹¤ìš´ ë§í¬ */
        .chat-message.assistant a {
            color: var(--accent);
            text-decoration: none;
        }

        .chat-message.assistant a:hover {
            text-decoration: underline;
        }

        /* ë§ˆí¬ë‹¤ìš´ ê°•ì¡° */
        .chat-message.assistant strong {
            color: var(--text-highlight);
            font-weight: 600;
        }

        .chat-message.assistant em {
            font-style: italic;
        }

        /* ë¸”ë¡ ì¸ìš© */
        .chat-message.assistant blockquote {
            border-left: 3px solid var(--accent);
            margin: 10px 0;
            padding: 8px 16px;
            background: var(--bg-primary);
            color: var(--text-secondary);
        }

        /* ìˆ˜í‰ì„  */
        .chat-message.assistant hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 12px 0;
        }

        /* í…Œì´ë¸” */
        .chat-message.assistant table {
            border-collapse: collapse;
            margin: 10px 0;
            width: 100%;
        }

        .chat-message.assistant th,
        .chat-message.assistant td {
            border: 1px solid var(--border);
            padding: 6px 10px;
            text-align: left;
        }

        .chat-message.assistant th {
            background: var(--bg-primary);
            font-weight: 600;
        }

        /* ë„êµ¬ ê´€ë ¨ ë©”ì‹œì§€ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .chat-message.tool-detected,
        .chat-message.tool-executing,
        .chat-message.tool-result {
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .chat-message.tool-detected pre,
        .chat-message.tool-result pre {
            white-space: pre-wrap;
            word-break: break-all;
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Code Diff in Message */
        .code-diff {
            background: var(--bg-primary);
            border-radius: 6px;
            margin: 8px 0;
            overflow: hidden;
        }

        .code-diff-header {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-diff-actions {
            display: flex;
            gap: 4px;
        }

        .code-diff-actions button {
            padding: 2px 8px;
            font-size: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .code-diff-actions .accept { background: var(--success); color: white; }
        .code-diff-actions .reject { background: var(--error); color: white; }

        .code-diff-content {
            padding: 8px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .diff-line { padding: 1px 8px; }
        .diff-add { background: rgba(76, 175, 80, 0.2); color: #98c379; }
        .diff-remove { background: rgba(244, 67, 54, 0.2); color: #e06c75; }
        .diff-context { color: var(--text-secondary); }

        /* Step Confirmation */
        .step-confirm {
            background: var(--bg-tertiary);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }

        .step-confirm-header {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-confirm-header .icon { color: var(--accent); }

        .step-confirm-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .step-confirm-actions button {
            padding: 6px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .step-confirm-actions .proceed { background: var(--success); color: white; }
        .step-confirm-actions .skip { background: var(--bg-hover); color: var(--text-primary); }
        .step-confirm-actions .cancel { background: var(--error); color: white; }

        /* Processing Indicator - Î±Î³Ï‰ Style */
        .processing-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(0, 120, 212, 0.15), rgba(0, 120, 212, 0.05));
            border-left: 3px solid var(--accent);
            border-radius: 0 8px 8px 0;
            margin: 8px 0;
        }

        .processing-symbols {
            display: flex;
            gap: 4px;
            font-size: 18px;
            font-weight: bold;
        }

        .processing-symbols .symbol {
            display: inline-block;
            animation: symbol-pulse 1.5s ease-in-out infinite;
        }

        .processing-symbols .alpha {
            color: #ff6b6b;
            animation-delay: 0s;
        }

        .processing-symbols .gamma {
            color: #4ecdc4;
            animation-delay: 0.3s;
        }

        .processing-symbols .omega {
            color: #ffe66d;
            animation-delay: 0.6s;
        }

        @keyframes symbol-pulse {
            0%, 100% {
                opacity: 0.3;
                transform: scale(0.8) translateY(0);
            }
            50% {
                opacity: 1;
                transform: scale(1.2) translateY(-3px);
            }
        }

        .processing-text {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            color: var(--text-primary);
        }

        .processing-status {
            font-weight: 500;
        }

        /* Typing Indicator (fallback) */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }

        /* Chat Input */
        .chat-input-container {
            display: flex;
            gap: 8px;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
        }

        .chat-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 13px;
            outline: none;
            resize: none;
            min-height: 40px;
            max-height: 150px;
            font-family: inherit;
            line-height: 1.4;
        }

        .chat-input:focus { border-color: var(--accent); }
        .chat-input::placeholder { color: var(--text-secondary); }

        .chat-send {
            padding: 10px 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }

        .chat-send:hover { background: var(--accent-hover); }
        .chat-send:disabled { opacity: 0.5; cursor: not-allowed; }

        .chat-stop {
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }
        .chat-stop:hover { background: #c0392b; }

        /* Search Panel */
        .search-container { padding: 8px; width: 100%; }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 13px;
            outline: none;
        }

        .search-input:focus { border-color: var(--accent); }
        .search-results { margin-top: 8px; }

        .search-result {
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .search-result:hover { background: var(--bg-hover); }
        .search-result .file { color: var(--accent); }
        .search-result .line { color: var(--text-secondary); }

        /* Status Bar */
        .status-bar {
            height: 24px;
            background: var(--accent);
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-size: 12px;
            color: white;
            justify-content: space-between;
        }

        .status-bar .left, .status-bar .right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 150px;
            display: none;
        }

        .context-menu.show { display: block; }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover { background: var(--bg-hover); }

        /* Loading */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--text-secondary);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Tool ì‹¤í–‰ ì‹œ ì„ì‹œ íŒŒì¼ í•˜ì´ë¼ì´íŠ¸ */
        .tool-highlight-line {
            background: rgba(76, 175, 80, 0.3) !important;
            border-left: 3px solid #4caf50 !important;
        }
        .tool-glyph-margin {
            background: #4caf50;
        }

        /* ë„êµ¬ ë°°ì§€ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }

        /* ì„ì‹œ íŒŒì¼ íƒ­ ìŠ¤íƒ€ì¼ */
        .tab.temp-preview {
            opacity: 0.7;
            border-left: 2px solid #ff9800;
        }
        .tab.temp-preview::before {
            content: 'ğŸ‘';
            margin-right: 4px;
            font-size: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <span class="logo">ğŸ§ </span>
                <h1 id="workspaceName">MAEUM_CODE</h1>
            </div>
            <div class="toolbar">
                <button onclick="createFile()" title="ìƒˆ íŒŒì¼">ğŸ“„</button>
                <button onclick="createFolder()" title="ìƒˆ í´ë”">ğŸ“</button>
                <button onclick="refreshFiles()" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
                <span style="border-left: 1px solid var(--border); margin: 0 4px;"></span>
                <button onclick="performUndo()" title="ì‹¤í–‰ ì·¨ì†Œ (Ctrl+Z)">â†©ï¸</button>
                <button onclick="performRedo()" title="ë‹¤ì‹œ ì‹¤í–‰ (Ctrl+Y)">â†ªï¸</button>
                <span style="border-left: 1px solid var(--border); margin: 0 4px;"></span>
                <button onclick="refreshIndex()" title="ì¸ë±ìŠ¤ ê°±ì‹ ">ğŸ”</button>
            </div>
            <div class="file-explorer" id="fileExplorer"></div>
        </div>

        <!-- Main Content -->
        <div class="main">
            <div class="tabs" id="tabs"></div>

            <div class="editor-container">
                <div id="editor">
                    <div class="welcome">
                        <h2>ğŸ§  MAEUM_CODE IDE</h2>
                        <p>ì™¼ìª½ íŒŒì¼ íƒìƒ‰ê¸°ì—ì„œ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</p>
                        <p><kbd>Ctrl+S</kbd> ì €ì¥ | <kbd>Ctrl+Z</kbd> ì‹¤í–‰ ì·¨ì†Œ | <kbd>Ctrl+F</kbd> ì°¾ê¸°</p>
                    </div>
                </div>
            </div>

            <div class="resize-handle" id="resizeHandle"></div>

            <!-- Bottom Panel - Claude Code Style -->
            <div class="bottom-panel" id="bottomPanel">
                <div class="panel-tabs">
                    <div class="panel-tab active" data-panel="ai">ğŸ¤– AI ì–´ì‹œìŠ¤í„´íŠ¸</div>
                    <div class="panel-tab" data-panel="search">ğŸ” ê²€ìƒ‰</div>
                    <div class="panel-tab" data-panel="output">ğŸ“‹ ì¶œë ¥</div>
                </div>
                <div class="panel-content" id="panelContent">
                    <!-- AI Panel with TodoList -->
                    <div class="panel-split" id="aiPanel">
                        <!-- TodoList -->
                        <div class="todo-panel">
                            <div class="todo-header">
                                <span>ğŸ“‹ ì§„í–‰ ìƒí™©</span>
                                <div class="todo-progress">
                                    <span id="todoCount">0/0</span>
                                    <div class="todo-progress-bar">
                                        <div class="todo-progress-fill" id="todoProgressFill" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="todo-list" id="todoList">
                                <div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 12px;">
                                    AIì—ê²Œ ì‘ì—…ì„ ìš”ì²­í•˜ë©´<br>ì§„í–‰ ìƒí™©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
                                </div>
                            </div>
                        </div>

                        <!-- Chat -->
                        <div class="chat-panel">
                            <div class="chat-messages" id="chatMessages">
                                <div class="chat-message assistant">
                                    ì•ˆë…•í•˜ì„¸ìš”! MAEUM_CODE AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. ğŸ§ <br><br>
                                    ì½”ë”© ì‘ì—…ì„ ìš”ì²­í•˜ì‹œë©´:<br>
                                    â€¢ ì™¼ìª½ì— ì§„í–‰ ìƒí™©(TodoList)ì´ í‘œì‹œë©ë‹ˆë‹¤<br>
                                    â€¢ ê° ë‹¨ê³„ë³„ë¡œ í™•ì¸ì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                                    â€¢ ì½”ë“œ ë³€ê²½ì‚¬í•­ì€ diffë¡œ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤<br><br>
                                    ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
                                </div>
                            </div>
                            <div class="chat-input-container">
                                <textarea class="chat-input" id="chatInput" rows="1"
                                       placeholder="ë©”ì‹œì§€ ì…ë ¥... (Enter: ì „ì†¡, Shift+Enter: ì¤„ë°”ê¿ˆ)"
                                       onkeydown="handleChatKeydown(event)"></textarea>
                                <button class="chat-send" id="chatSend" onclick="sendMessage()">ì „ì†¡</button>
                                <button class="chat-stop" id="chatStop" onclick="stopGeneration()" style="display:none;">ì¤‘ë‹¨</button>
                            </div>
                        </div>
                    </div>

                    <!-- Search Panel -->
                    <div class="search-container" id="searchPanel" style="display:none">
                        <input type="text" class="search-input" id="searchInput"
                               placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (Enterë¡œ ê²€ìƒ‰)"
                               onkeypress="if(event.key==='Enter') performSearch()">
                        <div class="search-results" id="searchResults"></div>
                    </div>

                    <!-- Output Panel -->
                    <div id="outputPanel" style="display:none; padding: 12px; width: 100%;">
                        <pre style="font-family: monospace; font-size: 12px;" id="outputContent"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="renameItem()">âœï¸ ì´ë¦„ ë³€ê²½</div>
        <div class="context-menu-item" onclick="deleteItem()">ğŸ—‘ï¸ ì‚­ì œ</div>
        <div class="context-menu-item" onclick="copyPath()">ğŸ“‹ ê²½ë¡œ ë³µì‚¬</div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="left">
            <span id="aiStatus">ğŸ¤– AI ì—°ê²° ì¤‘...</span>
            <span id="fileStatus"></span>
        </div>
        <div class="right">
            <span id="cursorPos">Ln 1, Col 1</span>
            <span id="language">Plain Text</span>
            <span>UTF-8</span>
        </div>
    </div>

    <script>
        // ============================================================
        // State
        // ============================================================
        let editor = null;
        let openFiles = new Map();
        let activeFile = null;
        let ws = null;
        let contextMenuTarget = null;
        let currentAssistantMessage = null;
        let currentRawContent = '';  // ë§ˆí¬ë‹¤ìš´ íŒŒì‹± ì „ ì›ë³¸ í…ìŠ¤íŠ¸
        let todos = [];
        let workspacePath = '';
        let workspaceName = '';

        // ============================================================
        // Initialize App
        // ============================================================
        function initializeApp() {
            console.log('ğŸš€ MAEUM_CODE IDE ì´ˆê¸°í™” ì‹œì‘');

            // Markdown-it ì„¤ì • (ë§ˆí¬ë‹¤ìš´ íŒŒì‹±)
            if (typeof markdownit !== 'undefined') {
                window.md = markdownit({
                    html: true,             // HTML íƒœê·¸ í—ˆìš©
                    breaks: true,           // GFM ì¤„ë°”ê¿ˆ
                    linkify: true,          // URL ìë™ ë§í¬
                    typographer: true,      // ë”°ì˜´í‘œ ë“± íƒ€ì´í¬ê·¸ë˜í”¼
                    highlight: function(code, lang) {
                        if (lang && hljs && hljs.getLanguage(lang)) {
                            try {
                                return hljs.highlight(code, { language: lang }).value;
                            } catch (e) {}
                        }
                        return hljs.highlightAuto(code).value;
                    }
                });
                console.log('âœ… Markdown-it ì„¤ì • ì™„ë£Œ');
            } else {
                console.warn('âš ï¸ Markdown-it ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì•ˆë¨');
            }

            // Monaco Editor ë¡œë“œ (ë¡œì»¬)
            require.config({ paths: { vs: '/static/monaco/min/vs' }});
            require(['vs/editor/editor.main'], function() {
                console.log('âœ… Monaco Editor loaded');

                monaco.editor.defineTheme('maeum-dark', {
                    base: 'vs-dark',
                    inherit: true,
                    rules: [],
                    colors: { 'editor.background': '#1e1e1e' }
                });

                loadWorkspaceInfo();
                loadFiles('');
                checkAIStatus();
                connectWebSocket();
            });
        }

        // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // ============================================================
        // Workspace Info
        // ============================================================
        async function loadWorkspaceInfo() {
            try {
                const response = await fetch('/api/workspace');
                const data = await response.json();
                workspacePath = data.path;
                workspaceName = data.name;
                document.getElementById('workspaceName').textContent = workspaceName;
                document.getElementById('workspaceName').title = workspacePath;
                document.title = `${workspaceName} - MAEUM_CODE IDE`;
            } catch (error) {
                console.error('Failed to load workspace info:', error);
            }
        }

        // ============================================================
        // TodoList Management
        // ============================================================
        function updateTodoList(newTodos) {
            todos = newTodos;
            const todoList = document.getElementById('todoList');
            const completed = todos.filter(t => t.status === 'completed').length;
            const total = todos.length;

            document.getElementById('todoCount').textContent = `${completed}/${total}`;
            document.getElementById('todoProgressFill').style.width = total ? `${(completed/total)*100}%` : '0%';

            if (todos.length === 0) {
                todoList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 12px;">
                        AIì—ê²Œ ì‘ì—…ì„ ìš”ì²­í•˜ë©´<br>ì§„í–‰ ìƒí™©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
                    </div>`;
                return;
            }

            todoList.innerHTML = todos.map((todo, i) => `
                <div class="todo-item ${todo.status}" data-index="${i}">
                    <div class="todo-status">
                        ${todo.status === 'completed' ? 'âœ“' : todo.status === 'in_progress' ? 'â–¶' : ''}
                    </div>
                    <span class="todo-text">${todo.status === 'in_progress' ? todo.activeForm : todo.content}</span>
                    ${todo.status === 'pending' ? '<button class="todo-action" onclick="skipTodo('+i+')">ê±´ë„ˆë›°ê¸°</button>' : ''}
                </div>
            `).join('');
        }

        function addTodo(content, activeForm) {
            todos.push({ content, activeForm, status: 'pending' });
            updateTodoList(todos);
        }

        // ============================================================
        // ë„êµ¬ ì‹¤í–‰ ì§„í–‰ ìƒí™© í‘œì‹œ
        // ============================================================
        let toolHistory = [];  // ì‹¤í–‰ëœ ë„êµ¬ ê¸°ë¡

        function addToolProgress(toolName, toolInput, status = 'executing', explorationInfo = null) {
            const todoList = document.getElementById('todoList');
            const countEl = document.getElementById('todoCount');
            const progressFill = document.getElementById('todoProgressFill');

            // ê¸°ì¡´ ë¹ˆ ë©”ì‹œì§€ ì œê±°
            const emptyMsg = todoList.querySelector('div[style*="text-align: center"]');
            if (emptyMsg) emptyMsg.remove();

            // ë„êµ¬ ê¸°ë¡ì— ì¶”ê°€
            if (status === 'executing') {
                toolHistory.push({ toolName, toolInput, status, explorationInfo });
            } else {
                // ìƒíƒœ ì—…ë°ì´íŠ¸
                const lastTool = toolHistory[toolHistory.length - 1];
                if (lastTool && lastTool.toolName === toolName) {
                    lastTool.status = status;
                }
            }

            // ì§„í–‰ ìƒí™© ë Œë”ë§
            renderToolProgress();
        }

        function renderToolProgress() {
            const todoList = document.getElementById('todoList');
            const countEl = document.getElementById('todoCount');
            const progressFill = document.getElementById('todoProgressFill');

            const completed = toolHistory.filter(t => t.status === 'completed').length;
            const total = toolHistory.length;

            countEl.textContent = `${completed}/${total}`;
            progressFill.style.width = total ? `${(completed/total)*100}%` : '0%';

            if (toolHistory.length === 0) {
                todoList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 12px;">
                        AIì—ê²Œ ì‘ì—…ì„ ìš”ì²­í•˜ë©´<br>ì§„í–‰ ìƒí™©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
                    </div>`;
                return;
            }

            todoList.innerHTML = toolHistory.map((tool, i) => {
                const icon = tool.status === 'completed' ? 'âœ…' :
                            tool.status === 'failed' ? 'âŒ' : 'ğŸ”„';
                const statusClass = tool.status === 'completed' ? 'completed' :
                                   tool.status === 'failed' ? 'failed' : 'in_progress';

                // ë„êµ¬ë³„ ì„¤ëª…
                let desc = '';
                if (tool.toolName === 'list_dir') {
                    desc = tool.toolInput?.path || '/';
                } else if (tool.toolName === 'read_file') {
                    desc = tool.toolInput?.file_path?.split('/').pop() || '';
                } else if (tool.toolName === 'search_code') {
                    desc = tool.toolInput?.query || '';
                } else if (tool.toolName === 'edit_file' || tool.toolName === 'write_file') {
                    desc = tool.toolInput?.file_path?.split('/').pop() || '';
                } else if (tool.toolName === 'bash') {
                    desc = (tool.toolInput?.command || '').slice(0, 30);
                } else {
                    desc = JSON.stringify(tool.toolInput || {}).slice(0, 30);
                }

                // íƒìƒ‰ ì¹´ìš´í„°
                const exploreTag = tool.explorationInfo
                    ? `<span style="color: #888; font-size: 10px; margin-left: 4px;">(${tool.explorationInfo.count}/${tool.explorationInfo.max})</span>`
                    : '';

                // íŒŒì¼ ê´€ë ¨ ë„êµ¬ëŠ” í´ë¦­ ì‹œ ì—ë””í„°ì—ì„œ ì—´ê¸°
                const isFileTool = ['read_file', 'edit_file', 'write_file', 'search_code'].includes(tool.toolName);
                const filePath = tool.toolInput?.file_path || tool.toolInput?.path || '';
                const lineNum = tool.toolInput?.offset || 1;

                const clickAction = isFileTool && filePath
                    ? `openFileInEditor('${filePath}', ${lineNum})`
                    : `confirmUndoToStep(${i})`;

                const tooltip = isFileTool && filePath
                    ? 'í´ë¦­í•˜ì—¬ ì—ë””í„°ì—ì„œ ì—´ê¸°'
                    : 'í´ë¦­í•˜ì—¬ ì´ ì‹œì ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°';

                return `
                    <div class="todo-item ${statusClass}" style="padding: 6px 10px; border-bottom: 1px solid var(--border); cursor: pointer;"
                         onclick="${clickAction}" title="${tooltip}">
                        <span style="margin-right: 8px;">${icon}</span>
                        <span style="color: #4fc3f7; font-weight: 500;">${tool.toolName}</span>${exploreTag}
                        <span style="color: var(--text-secondary); font-size: 11px; margin-left: 8px;">${desc}</span>
                    </div>
                `;
            }).join('');

            // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
            todoList.scrollTop = todoList.scrollHeight;
        }

        function clearToolProgress() {
            toolHistory = [];
            renderToolProgress();
        }

        async function confirmUndoToStep(stepIndex) {
            const tool = toolHistory[stepIndex];
            if (!tool) return;

            // ìˆ˜ì • ë„êµ¬ë§Œ undo ê°€ëŠ¥
            const undoableTools = ['edit_file', 'write_file', 'bash'];
            if (!undoableTools.includes(tool.toolName)) {
                alert('íƒìƒ‰ ë„êµ¬(read_file, list_dir ë“±)ëŠ” ë˜ëŒë¦¬ê¸°ê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            const stepsToUndo = toolHistory.length - stepIndex - 1;
            if (stepsToUndo <= 0) {
                alert('ì´ë¯¸ ë§ˆì§€ë§‰ ë‹¨ê³„ì…ë‹ˆë‹¤.');
                return;
            }

            const confirmed = confirm(
                `"${tool.toolName}" ì‹œì ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
                `${stepsToUndo}ê°œì˜ ì‘ì—…ì´ ì·¨ì†Œë©ë‹ˆë‹¤.\n` +
                `(Undo ê¸°ëŠ¥ìœ¼ë¡œ ë˜ëŒë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)`
            );

            if (confirmed) {
                // ì—¬ëŸ¬ ë²ˆ undo ì‹¤í–‰
                for (let i = 0; i < stepsToUndo; i++) {
                    try {
                        const response = await fetch('/undo', { method: 'POST' });
                        const result = await response.json();
                        if (!result.success) {
                            alert(`Undo ì‹¤íŒ¨: ${result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                            break;
                        }
                    } catch (e) {
                        alert(`Undo ì˜¤ë¥˜: ${e.message}`);
                        break;
                    }
                }

                // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                toolHistory = toolHistory.slice(0, stepIndex + 1);
                renderToolProgress();
                addOutput(`â†©ï¸ ${stepsToUndo}ê°œ ì‘ì—… ì·¨ì†Œë¨`);
            }
        }

        function setTodoInProgress(index) {
            if (todos[index]) {
                todos.forEach((t, i) => { if (t.status === 'in_progress') t.status = 'pending'; });
                todos[index].status = 'in_progress';
                updateTodoList(todos);
            }
        }

        function completeTodo(index) {
            if (todos[index]) {
                todos[index].status = 'completed';
                updateTodoList(todos);
            }
        }

        function skipTodo(index) {
            todos.splice(index, 1);
            updateTodoList(todos);
        }

        // ============================================================
        // Code Diff Display
        // ============================================================
        function showCodeDiff(filePath, oldCode, newCode, onAccept, onReject) {
            const diffHtml = `
                <div class="code-diff">
                    <div class="code-diff-header">
                        <span>ğŸ“ ${filePath}</span>
                        <div class="code-diff-actions">
                            <button class="accept" onclick="(${onAccept})()">âœ“ ì ìš©</button>
                            <button class="reject" onclick="(${onReject})()">âœ— ê±°ë¶€</button>
                        </div>
                    </div>
                    <div class="code-diff-content">
                        ${generateDiffLines(oldCode, newCode)}
                    </div>
                </div>
            `;
            return diffHtml;
        }

        function generateDiffLines(oldCode, newCode) {
            const oldLines = oldCode.split('\n');
            const newLines = newCode.split('\n');
            let html = '';

            // Simple diff (not optimal but functional)
            const maxLen = Math.max(oldLines.length, newLines.length);
            for (let i = 0; i < maxLen; i++) {
                const oldLine = oldLines[i] || '';
                const newLine = newLines[i] || '';

                if (oldLine === newLine) {
                    html += `<div class="diff-line diff-context">  ${escapeHtml(oldLine)}</div>`;
                } else {
                    if (oldLine) html += `<div class="diff-line diff-remove">- ${escapeHtml(oldLine)}</div>`;
                    if (newLine) html += `<div class="diff-line diff-add">+ ${escapeHtml(newLine)}</div>`;
                }
            }
            return html;
        }

        // ============================================================
        // Step Confirmation
        // ============================================================
        function showStepConfirmation(stepDescription, onProceed, onSkip, onCancel) {
            const html = `
                <div class="step-confirm">
                    <div class="step-confirm-header">
                        <span class="icon">â“</span>
                        <span>${stepDescription}</span>
                    </div>
                    <div class="step-confirm-actions">
                        <button class="proceed" onclick="handleStepAction('proceed')">âœ“ ì§„í–‰</button>
                        <button class="skip" onclick="handleStepAction('skip')">ê±´ë„ˆë›°ê¸°</button>
                        <button class="cancel" onclick="handleStepAction('cancel')">ì·¨ì†Œ</button>
                    </div>
                </div>
            `;
            return html;
        }

        let pendingStepAction = null;
        function handleStepAction(action) {
            if (pendingStepAction) {
                pendingStepAction(action);
                pendingStepAction = null;
            }
        }

        // ============================================================
        // WebSocket & Chat
        // ============================================================
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/chat`;
            console.log('Connecting to WebSocket:', wsUrl);

            try {
                ws = new WebSocket(wsUrl);
            } catch (e) {
                console.error('WebSocket creation failed:', e);
                document.getElementById('aiStatus').textContent = 'ğŸ¤– ì—°ê²° ì‹¤íŒ¨';
                return;
            }

            ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('aiStatus').textContent = 'ğŸ¤– AI ì—°ê²°ë¨';
                enableChat();  // ì—°ê²°ë˜ë©´ ì±„íŒ… í™œì„±í™”
            };

            ws.onclose = (event) => {
                console.log('WebSocket disconnected:', event.code, event.reason);
                document.getElementById('aiStatus').textContent = 'ğŸ¤– AI ì—°ê²° ëŠê¹€ (ì¬ì—°ê²° ì¤‘...)';
                disableChat();  // ì—°ê²° ëŠê¸°ë©´ ì±„íŒ… ë¹„í™œì„±í™”
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                document.getElementById('aiStatus').textContent = 'ğŸ¤– ì—°ê²° ì˜¤ë¥˜';
            };

            ws.onmessage = (event) => {
                try {
                    handleChatResponse(JSON.parse(event.data));
                } catch (e) {
                    console.error('Message parse error:', e, event.data);
                }
            };
        }

        // ESC í‚¤ë¡œ ì‘ì—… ì·¨ì†Œ
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'cancel' }));
                addOutput('âš ï¸ ESC: ì‘ì—… ì·¨ì†Œ ìš”ì²­');
            }
        });

        // í˜„ì¬ ë„êµ¬ í™•ì¸ ID
        let pendingConfirmationId = null;

        function handleChatResponse(data) {
            const messages = document.getElementById('chatMessages');

            // Remove processing indicator
            const processingEl = document.getElementById('processingIndicator');
            if (processingEl) processingEl.remove();

            // Remove typing indicator (fallback)
            const typingEl = document.querySelector('.typing-indicator');
            if (typingEl) typingEl.remove();

            // ========== Agentic Loop ë©”ì‹œì§€ ì²˜ë¦¬ ==========

            // ë„êµ¬ ê°ì§€ë¨ (êµ¬ì¡°í™”ëœ tool_use íŒ¨í„´)
            if (data.type === 'tool_detected') {
                const toolMsg = document.createElement('div');
                toolMsg.className = 'chat-message tool-detected';
                const inputPreview = JSON.stringify(data.tool_input, null, 2).slice(0, 200);
                toolMsg.innerHTML = `
                    <span class="tool-icon">ğŸ”§</span>
                    <strong>${data.tool_name}</strong> í˜¸ì¶œ ê°ì§€
                    <pre style="margin: 4px 0 0 0; font-size: 11px; color: #aaa; white-space: pre-wrap; word-break: break-all; max-width: 100%;">${inputPreview}</pre>
                `;
                toolMsg.style.cssText = 'background: #2a3a4a; border-left: 3px solid #2196f3; padding: 8px 12px; margin: 8px 0; font-size: 12px; word-wrap: break-word; overflow-wrap: break-word;';
                messages.appendChild(toolMsg);
                return;
            }

            // ë„êµ¬ ì‹¤í–‰ í™•ì¸ ìš”ì²­
            if (data.type === 'tool_confirm_request') {
                pendingConfirmationId = data.confirmation_id;
                showToolConfirmDialog(data);
                return;
            }

            // ë„êµ¬ ì‹¤í–‰ ì¤‘
            if (data.type === 'tool_executing') {
                // ì§„í–‰ ìƒí™© íŒ¨ë„ì— ì¶”ê°€
                const exploreInfo = data.exploration_count
                    ? { count: data.exploration_count, max: data.max_exploration }
                    : null;
                addToolProgress(data.tool_name, data.tool_input, 'executing', exploreInfo);
                return;
            }

            // ë„êµ¬ ì‹¤í–‰ ê²°ê³¼
            if (data.type === 'tool_result') {
                const success = data.result && data.result.success;
                // ì§„í–‰ ìƒí™© íŒ¨ë„ ì—…ë°ì´íŠ¸
                addToolProgress(data.tool_name, null, success ? 'completed' : 'failed');
                return;
            }

            // íŒŒì¼ ì—ë””í„°ì—ì„œ ì—´ê¸° (ë„êµ¬ ì‹¤í–‰ ì‹œ ìë™)
            if (data.type === 'open_in_editor') {
                console.log('ğŸ“‚ ì—ë””í„°ì—ì„œ íŒŒì¼ ì—´ê¸°:', data.file_path);
                openFileInEditor(data.file_path, data.line || 1, data.tool_name);
                return;
            }

            // íŒŒì¼ ìˆ˜ì •ë¨ - ì—ë””í„° ìƒˆë¡œê³ ì¹¨
            if (data.type === 'file_modified') {
                console.log('ğŸ“ íŒŒì¼ ìˆ˜ì •ë¨:', data.file_path, data.action);
                refreshFileInEditor(data.file_path, data.action);
                return;
            }

            // í™•ì¸ ëŒ€ê¸° ì¤‘
            if (data.type === 'waiting_confirmation') {
                addOutput('â³ ì‚¬ìš©ì í™•ì¸ ëŒ€ê¸° ì¤‘...');
                return;
            }

            // ì·¨ì†Œë¨
            if (data.type === 'cancelled') {
                addOutput('âš ï¸ ' + data.content);
                enableChat();
                return;
            }

            // ========== ì¼ë°˜ ì±„íŒ… ë©”ì‹œì§€ ==========

            if (data.type === 'token') {
                if (!currentAssistantMessage) {
                    currentAssistantMessage = document.createElement('div');
                    currentAssistantMessage.className = 'chat-message assistant';
                    currentRawContent = '';  // ì›ë³¸ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
                    messages.appendChild(currentAssistantMessage);
                }
                // ì›ë³¸ í…ìŠ¤íŠ¸ì— ì¶”ê°€
                currentRawContent += data.content;
                // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì—ë„ ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ (throttle)
                renderMarkdown(currentAssistantMessage, currentRawContent);
                // ìë™ ìŠ¤í¬ë¡¤ ì œê±° - ì‚¬ìš©ìê°€ ììœ ë¡­ê²Œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥

                // Parse for todos and code blocks
                parseTodosFromContent(currentRawContent);

            } else if (data.type === 'done') {
                if (currentAssistantMessage && currentRawContent) {
                    // ìµœì¢… ë§ˆí¬ë‹¤ìš´ íŒŒì‹± (ê°•ì œ)
                    renderMarkdown(currentAssistantMessage, currentRawContent, true);

                    // ì½”ë“œ í•˜ì´ë¼ì´íŒ… (ì™„ë£Œ ì‹œ ì „ì²´ ì ìš©)
                    if (typeof hljs !== 'undefined') {
                        setTimeout(() => {
                            currentAssistantMessage?.querySelectorAll('pre code:not(.hljs)').forEach(block => {
                                try { hljs.highlightElement(block); } catch (e) {}
                            });
                        }, 50);
                    }
                    console.log('âœ… Markdown parsed successfully');
                }
                currentAssistantMessage = null;
                currentRawContent = '';
                lastRenderedLength = 0;  // ë Œë”ë§ ì¹´ìš´í„° ë¦¬ì…‹
                enableChat();

            } else if (data.type === 'error') {
                const errorMsg = document.createElement('div');
                errorMsg.className = 'chat-message assistant';
                errorMsg.style.borderLeft = '3px solid var(--error)';
                errorMsg.textContent = 'ì˜¤ë¥˜: ' + data.content;
                messages.appendChild(errorMsg);
                currentAssistantMessage = null;
                enableChat();
            }
        }

        // ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ í•¨ìˆ˜ (ì‹¤ì‹œê°„ ë Œë”ë§ - ê°œì„ )
        let renderTimer = null;
        let lastRenderedLength = 0;
        const RENDER_INTERVAL = 30;  // 30msë§ˆë‹¤ ë Œë”ë§

        function renderMarkdown(element, content, force = false) {
            // ê°•ì œ ë Œë”ë§ ì‹œ ì¦‰ì‹œ ì‹¤í–‰
            if (force) {
                if (renderTimer) {
                    clearTimeout(renderTimer);
                    renderTimer = null;
                }
                doRender(element, content);
                lastRenderedLength = content.length;
                return;
            }

            // ì½˜í…ì¸ ê°€ ì¶©ë¶„íˆ ë³€ê²½ëì„ ë•Œë§Œ ë Œë”ë§ (ì„±ëŠ¥ ìµœì í™”)
            const contentChanged = content.length - lastRenderedLength > 10;

            if (!renderTimer && contentChanged) {
                renderTimer = setTimeout(() => {
                    renderTimer = null;
                    doRender(element, content);
                    lastRenderedLength = content.length;
                }, RENDER_INTERVAL);
            }
        }

        function doRender(element, content) {
            if (!element || !content) return;

            // markdown-it ì—†ìœ¼ë©´ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
            if (!window.md) {
                element.innerHTML = content.replace(/\n/g, '<br>');
                return;
            }

            try {
                // ë¶ˆì™„ì „í•œ ì½”ë“œ ë¸”ë¡ ì²˜ë¦¬ (ìŠ¤íŠ¸ë¦¬ë° ì¤‘)
                let safeContent = content;

                // ì—´ë¦° ``` ë¸”ë¡ì´ í™€ìˆ˜ê°œë©´ ì„ì‹œë¡œ ë‹«ê¸°
                const backtickCount = (content.match(/```/g) || []).length;
                if (backtickCount % 2 === 1) {
                    safeContent += '\n```';
                }

                // ë§ˆí¬ë‹¤ìš´ íŒŒì‹± (markdown-it)
                const parsedHtml = window.md.render(safeContent);
                element.innerHTML = parsedHtml;

                // ì½”ë“œ í•˜ì´ë¼ì´íŒ… (ì§§ì€ ì½˜í…ì¸ ë§Œ, ê¸´ ì½˜í…ì¸ ëŠ” ì™„ë£Œ ì‹œì—ë§Œ)
                if (typeof hljs !== 'undefined' && content.length < 5000) {
                    element.querySelectorAll('pre code:not(.hljs)').forEach(block => {
                        try {
                            hljs.highlightElement(block);
                        } catch (e) {}
                    });
                }
            } catch (e) {
                console.error('âŒ Markdown parsing error:', e);
                // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì¤„ë°”ê¿ˆë§Œ ì²˜ë¦¬
                element.innerHTML = content.replace(/\n/g, '<br>');
            }
        }

        function parseTodosFromContent(content) {
            // Look for todo patterns like "1. xxx", "- [ ] xxx"
            const todoPatterns = [
                /(\d+)\.\s+(.+)/g,
                /-\s*\[\s*\]\s+(.+)/g,
                /â€¢\s+(.+)/g
            ];

            // This is a simplified parser - real implementation would be more sophisticated
        }

        // ============================================================
        // Tool Confirmation Dialog (Agentic Loop)
        // ============================================================
        function showToolConfirmDialog(data) {
            const overlay = document.createElement('div');
            overlay.id = 'toolConfirmOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const toolIcons = {
                'bash': 'ğŸ’»',
                'write_file': 'ğŸ“',
                'edit_file': 'âœï¸',
                'read_file': 'ğŸ“–',
                'list_dir': 'ğŸ“‚',
                'search_code': 'ğŸ”'
            };

            const icon = toolIcons[data.tool_name] || 'ğŸ”§';

            // ìœ„í—˜ë„ í‘œì‹œ
            const isDangerous = ['bash', 'write_file', 'edit_file'].includes(data.tool_name);

            overlay.innerHTML = `
                <div style="
                    background: #252526;
                    border: 1px solid ${isDangerous ? '#f44336' : '#4caf50'};
                    border-radius: 8px;
                    padding: 20px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                ">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <span style="font-size: 24px;">${icon}</span>
                        <div>
                            <div style="color: ${isDangerous ? '#f44336' : '#4caf50'}; font-weight: bold; font-size: 16px;">
                                ${isDangerous ? 'âš ï¸ í™•ì¸ í•„ìš”' : 'ë„êµ¬ ì‹¤í–‰'}
                            </div>
                            <div style="color: #ccc; font-size: 14px;">${data.description}</div>
                        </div>
                    </div>

                    <div style="background: #1e1e1e; padding: 12px; border-radius: 4px; margin-bottom: 16px; max-height: 200px; overflow: auto;">
                        <div style="color: #888; font-size: 11px; margin-bottom: 4px;">ë„êµ¬: ${data.tool_name}</div>
                        <pre style="color: #ddd; font-size: 12px; margin: 0; white-space: pre-wrap;">${JSON.stringify(data.tool_input, null, 2)}</pre>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="respondToolConfirm(false)" style="
                            padding: 8px 20px;
                            background: #444;
                            color: #fff;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                        ">âŒ ê±°ë¶€</button>
                        <button onclick="respondToolConfirm(true)" style="
                            padding: 8px 20px;
                            background: ${isDangerous ? '#f44336' : '#4caf50'};
                            color: #fff;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: bold;
                        ">âœ… ìŠ¹ì¸</button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            // ESCë¡œ ê±°ë¶€
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    respondToolConfirm(false);
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }

        function respondToolConfirm(approved) {
            const overlay = document.getElementById('toolConfirmOverlay');
            if (overlay) overlay.remove();

            if (pendingConfirmationId && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'tool_confirm',
                    confirmation_id: pendingConfirmationId,
                    approved: approved
                }));
                addOutput(approved ? 'âœ… ë„êµ¬ ì‹¤í–‰ ìŠ¹ì¸' : 'âŒ ë„êµ¬ ì‹¤í–‰ ê±°ë¶€');
                pendingConfirmationId = null;

                // ê±°ë¶€ ì‹œ ì±„íŒ… ì…ë ¥ ë‹¤ì‹œ í™œì„±í™”
                if (!approved) {
                    enableChat();
                }
            }
        }

        // Shift+Enter: ì¤„ë°”ê¿ˆ, Enter: ì „ì†¡
        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
            // Shift+EnterëŠ” ê¸°ë³¸ ë™ì‘ (ì¤„ë°”ê¿ˆ) í—ˆìš©

            // textarea ìë™ ë†’ì´ ì¡°ì ˆ
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            console.log('sendMessage called:', { message, wsExists: !!ws, wsState: ws?.readyState });

            if (!message) {
                console.log('No message');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.log('WebSocket not connected, reconnecting...');
                alert('AI ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¬ì—°ê²° ì‹œë„ ì¤‘...');
                connectWebSocket();
                return;
            }

            // ìƒˆ ëŒ€í™” ì‹œì‘ - ì§„í–‰ ìƒí™© ì´ˆê¸°í™”
            clearToolProgress();

            // Show user message
            const messages = document.getElementById('chatMessages');
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message user';
            userMsg.textContent = message;
            messages.appendChild(userMsg);

            // Show Claude-style processing indicator
            const processingIndicator = document.createElement('div');
            processingIndicator.className = 'processing-indicator';
            processingIndicator.id = 'processingIndicator';
            processingIndicator.innerHTML = `
                <div class="processing-symbols">
                    <span class="symbol alpha">Î±</span>
                    <span class="symbol gamma">Î³</span>
                    <span class="symbol omega">Ï‰</span>
                </div>
                <div class="processing-text">
                    <span class="processing-status">ì²˜ë¦¬ ì¤‘</span>
                </div>
            `;
            messages.appendChild(processingIndicator);

            // Get context with file info
            let context = '';
            let currentFile = null;
            let openTabs = [];

            if (activeFile && editor) {
                const selection = editor.getModel().getValueInRange(editor.getSelection());
                const fullContent = editor.getValue();

                // ì„ íƒ ì˜ì—­ ìˆìœ¼ë©´ ì„ íƒ ì˜ì—­, ì—†ìœ¼ë©´ ì»¤ì„œ ì£¼ë³€ ì½”ë“œ
                if (selection) {
                    context = selection;
                } else {
                    // ì»¤ì„œ ìœ„ì¹˜ ê¸°ì¤€ ì•ë’¤ 1500ìì”© (ì´ 3000ì)
                    const cursorOffset = editor.getModel().getOffsetAt(editor.getPosition());
                    const start = Math.max(0, cursorOffset - 1500);
                    const end = Math.min(fullContent.length, cursorOffset + 1500);
                    context = fullContent.substring(start, end);
                }

                currentFile = {
                    path: activeFile,
                    language: openFiles.get(activeFile)?.language || 'unknown',
                    totalLines: editor.getModel().getLineCount(),
                    cursorLine: editor.getPosition().lineNumber
                };
            }

            // ì—´ë¦° íƒ­ ëª©ë¡
            openTabs = Array.from(openFiles.keys());

            // Send with enhanced context
            ws.send(JSON.stringify({
                message,
                context,
                currentFile,
                openTabs
            }));

            input.value = '';
            input.style.height = 'auto';  // ë†’ì´ ì´ˆê¸°í™”
            disableChat();
            messages.scrollTop = messages.scrollHeight;
        }

        function disableChat() {
            document.getElementById('chatSend').disabled = true;
            document.getElementById('chatSend').style.display = 'none';
            document.getElementById('chatStop').style.display = 'inline-block';
            document.getElementById('chatInput').disabled = true;
        }

        function enableChat() {
            document.getElementById('chatSend').disabled = false;
            document.getElementById('chatSend').style.display = 'inline-block';
            document.getElementById('chatStop').style.display = 'none';
            document.getElementById('chatInput').disabled = false;
            document.getElementById('chatInput').focus();
        }

        async function stopGeneration() {
            console.log('ğŸ›‘ ì‚¬ìš©ìê°€ ìƒì„± ì¤‘ë‹¨ ìš”ì²­');
            try {
                const response = await fetch('/api/abort', { method: 'POST' });
                const result = await response.json();
                console.log('Abort result:', result);

                // ì²˜ë¦¬ ì¤‘ í‘œì‹œ ì œê±°
                const indicator = document.getElementById('processingIndicator');
                if (indicator) indicator.remove();

                // ì¤‘ë‹¨ ë©”ì‹œì§€ í‘œì‹œ
                const messages = document.getElementById('chatMessages');
                const stopMsg = document.createElement('div');
                stopMsg.className = 'chat-message assistant';
                stopMsg.innerHTML = '<em style="color: #e74c3c;">â¹ï¸ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë¨</em>';
                messages.appendChild(stopMsg);

                enableChat();
            } catch (e) {
                console.error('Abort failed:', e);
            }
        }

        // AIê°€ íŒŒì¼ ìˆ˜ì • í›„ ì—ë””í„° ìƒˆë¡œê³ ì¹¨
        async function refreshFileInEditor(filePath, action) {
            try {
                // í•´ë‹¹ íŒŒì¼ì´ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸
                if (!openFiles.has(filePath)) {
                    // ì—´ë ¤ìˆì§€ ì•Šìœ¼ë©´ ì—´ê¸°
                    await openFile(filePath);
                } else {
                    // ì—´ë ¤ìˆìœ¼ë©´ ë‚´ìš© ìƒˆë¡œê³ ì¹¨
                    const response = await fetch(`/api/file?path=${encodeURIComponent(filePath)}`);
                    const data = await response.json();

                    if (data.content !== undefined) {
                        const fileData = openFiles.get(filePath);
                        if (fileData && fileData.model) {
                            // ëª¨ë¸ ë‚´ìš© ì—…ë°ì´íŠ¸
                            fileData.model.setValue(data.content);
                            fileData.originalContent = data.content;
                            fileData.modified = false;
                            updateTab(filePath, false);
                        }
                    }
                }

                // ë³€ê²½ í‘œì‹œ ë°°ì§€
                const badge = document.createElement('div');
                badge.className = 'editor-tool-badge';
                badge.innerHTML = `âœï¸ ${action === 'created' ? 'ìƒì„±ë¨' : 'ìˆ˜ì •ë¨'}: ${filePath.split('/').pop()}`;
                badge.style.cssText = `
                    position: absolute;
                    top: 40px;
                    right: 10px;
                    background: #ff9800;
                    color: white;
                    padding: 4px 12px;
                    border-radius: 4px;
                    font-size: 12px;
                    z-index: 1000;
                    animation: fadeInOut 3s ease-in-out;
                `;
                document.getElementById('editor').appendChild(badge);
                setTimeout(() => badge.remove(), 3000);

                console.log(`âœ… íŒŒì¼ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ: ${filePath}`);
            } catch (error) {
                console.error('âŒ íŒŒì¼ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
            }
        }

        // ============================================================
        // File Operations
        // ============================================================
        async function loadFiles(path) {
            try {
                console.log('ğŸ“ loadFiles í˜¸ì¶œ:', path);
                const response = await fetch(`/api/files?path=${encodeURIComponent(path)}`);
                console.log('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ API ì—ëŸ¬:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('ğŸ“‹ íŒŒì¼ ëª©ë¡:', data);

                const explorer = document.getElementById('fileExplorer');
                explorer.innerHTML = '';

                if (path) {
                    const parentPath = path.split('/').slice(0, -1).join('/');
                    explorer.appendChild(createFileItem('..', parentPath, true));
                }

                if (data.items && Array.isArray(data.items)) {
                    if (data.items.length === 0) {
                        explorer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 12px;">ë¹ˆ ë””ë ‰í† ë¦¬</div>';
                    } else {
                        data.items.forEach(item => {
                            explorer.appendChild(createFileItem(item.name, item.path, item.is_directory));
                        });
                        console.log('âœ… íŒŒì¼ ëª©ë¡ ë Œë”ë§ ì™„ë£Œ:', data.items.length, 'ê°œ');
                    }
                } else {
                    console.error('âŒ ì˜ëª»ëœ ì‘ë‹µ í˜•ì‹:', data);
                    explorer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--error); font-size: 12px;">íŒŒì¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨</div>';
                }
            } catch (error) {
                console.error('âŒ loadFiles ì‹¤íŒ¨:', error);
                const explorer = document.getElementById('fileExplorer');
                explorer.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--error); font-size: 12px;">ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        function createFileItem(name, path, isDirectory) {
            const item = document.createElement('div');
            item.className = `file-item${isDirectory ? ' directory' : ''}`;
            item.dataset.path = path;

            const icon = isDirectory ? 'ğŸ“' : getFileIcon(name);
            item.innerHTML = `<span class="icon">${icon}</span><span class="name">${name}</span>`;

            item.onclick = () => isDirectory ? loadFiles(path) : openFile(path);
            item.oncontextmenu = (e) => { e.preventDefault(); showContextMenu(e, path, isDirectory); };

            return item;
        }

        function getFileIcon(name) {
            const ext = name.split('.').pop().toLowerCase();
            const icons = {
                'py': 'ğŸ', 'js': 'ğŸ“œ', 'ts': 'ğŸ“˜', 'html': 'ğŸŒ', 'css': 'ğŸ¨',
                'json': 'ğŸ“‹', 'md': 'ğŸ“', 'txt': 'ğŸ“„', 'sh': 'ğŸ’»', 'sql': 'ğŸ—ƒï¸'
            };
            return icons[ext] || 'ğŸ“„';
        }

        async function openFile(path) {
            try {
                if (openFiles.has(path)) { activateTab(path); return; }

                const response = await fetch(`/api/file?path=${encodeURIComponent(path)}`);
                const data = await response.json();

                if (data.is_binary) { alert('ë°”ì´ë„ˆë¦¬ íŒŒì¼ì€ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

                if (!editor) {
                    document.getElementById('editor').innerHTML = '';
                    editor = monaco.editor.create(document.getElementById('editor'), {
                        value: data.content,
                        language: data.language,
                        theme: 'maeum-dark',
                        fontSize: 14,
                        fontFamily: "'Fira Code', Consolas, monospace",
                        minimap: { enabled: true },
                        automaticLayout: true,
                        wordWrap: 'on'
                    });

                    editor.onDidChangeModelContent(() => {
                        if (activeFile) {
                            const fileData = openFiles.get(activeFile);
                            if (fileData) {
                                fileData.modified = editor.getValue() !== fileData.originalContent;
                                updateTab(activeFile, fileData.modified);
                            }
                        }
                    });

                    editor.onDidChangeCursorPosition((e) => {
                        document.getElementById('cursorPos').textContent = `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
                    });

                    editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, saveCurrentFile);
                }

                const model = monaco.editor.createModel(data.content, data.language);
                openFiles.set(path, { content: data.content, originalContent: data.content, modified: false, model, language: data.language });

                addTab(path);
                activateTab(path);
                document.getElementById('language').textContent = data.language;
            } catch (error) {
                console.error('Failed to open file:', error);
            }
        }

        // í˜„ì¬ ì„ì‹œ í”„ë¦¬ë·° íŒŒì¼ ì¶”ì 
        let tempPreviewFile = null;

        // AI ë„êµ¬ ì‹¤í–‰ ì‹œ ì—ë””í„°ì—ì„œ íŒŒì¼ ì—´ê¸° (ì¼ì‹œì  ë¯¸ë¦¬ë³´ê¸°)
        async function openFileInEditor(filePath, lineNumber = 1, toolName = '') {
            try {
                // ì´ì „ ì„ì‹œ í”„ë¦¬ë·° ë‹«ê¸° (ìŒ“ì´ì§€ ì•Šë„ë¡)
                if (tempPreviewFile && tempPreviewFile !== activeFile) {
                    const prevData = openFiles.get(tempPreviewFile);
                    // ìˆ˜ì •ë˜ì§€ ì•Šì€ ì„ì‹œ íŒŒì¼ë§Œ ë‹«ê¸°
                    if (prevData && !prevData.modified) {
                        closeTabSilent(tempPreviewFile);
                    }
                }

                // ì´ë¯¸ ì—´ë¦° íŒŒì¼ì¸ì§€ í™•ì¸
                const alreadyOpen = openFiles.has(filePath);

                // íŒŒì¼ ì—´ê¸°
                await openFile(filePath);

                // ì„ì‹œ í”„ë¦¬ë·°ë¡œ í‘œì‹œ (ìƒˆë¡œ ì—´ë¦° íŒŒì¼ë§Œ)
                if (!alreadyOpen) {
                    tempPreviewFile = filePath;
                    const tab = document.querySelector(`.tab[data-path="${filePath}"]`);
                    if (tab) tab.classList.add('temp-preview');
                }

                // ì ì‹œ ëŒ€ê¸° í›„ ë¼ì¸ìœ¼ë¡œ ì´ë™
                setTimeout(() => {
                    if (editor) {
                        // íŠ¹ì • ë¼ì¸ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                        editor.revealLineInCenter(lineNumber);
                        editor.setPosition({ lineNumber: lineNumber, column: 1 });

                        // í•´ë‹¹ ë¼ì¸ í•˜ì´ë¼ì´íŠ¸
                        const decoration = editor.deltaDecorations([], [{
                            range: new monaco.Range(lineNumber, 1, lineNumber, 1),
                            options: {
                                isWholeLine: true,
                                className: 'tool-highlight-line',
                                glyphMarginClassName: 'tool-glyph-margin'
                            }
                        }]);

                        // 3ì´ˆ í›„ í•˜ì´ë¼ì´íŠ¸ ì œê±°
                        setTimeout(() => {
                            editor.deltaDecorations(decoration, []);
                        }, 3000);
                    }

                    // ë„êµ¬ ë°°ì§€ í‘œì‹œ
                    const toolBadge = document.createElement('div');
                    toolBadge.className = 'editor-tool-badge';
                    toolBadge.innerHTML = `ğŸ”§ ${toolName}: ${filePath.split('/').pop()}`;
                    toolBadge.style.cssText = `
                        position: absolute;
                        top: 40px;
                        right: 10px;
                        background: #4caf50;
                        color: white;
                        padding: 4px 12px;
                        border-radius: 4px;
                        font-size: 12px;
                        z-index: 1000;
                        animation: fadeInOut 3s ease-in-out;
                    `;
                    document.getElementById('editor').appendChild(toolBadge);
                    setTimeout(() => toolBadge.remove(), 3000);

                }, 200);

                console.log(`ğŸ‘ ì„ì‹œ ë¯¸ë¦¬ë³´ê¸°: ${filePath} (ë¼ì¸ ${lineNumber})`);
            } catch (error) {
                console.error('âŒ ì—ë””í„°ì—ì„œ íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨:', error);
            }
        }

        // ì¡°ìš©íˆ íƒ­ ë‹«ê¸° (ì•Œë¦¼ ì—†ì´)
        function closeTabSilent(path) {
            const fileData = openFiles.get(path);
            if (fileData) {
                if (fileData.model) fileData.model.dispose();
                openFiles.delete(path);
            }

            const tab = document.querySelector(`.tab[data-path="${path}"]`);
            if (tab) tab.remove();

            // ë‹¤ë¥¸ íƒ­ í™œì„±í™”
            if (activeFile === path) {
                const tabs = document.querySelectorAll('.tab');
                if (tabs.length > 0) {
                    activateTab(tabs[0].dataset.path);
                } else {
                    activeFile = null;
                    if (editor) {
                        editor.setModel(monaco.editor.createModel('', 'plaintext'));
                    }
                }
            }

            // ì„ì‹œ í”„ë¦¬ë·° ì´ˆê¸°í™”
            if (tempPreviewFile === path) {
                tempPreviewFile = null;
            }
        }

        function addTab(path) {
            const tabs = document.getElementById('tabs');
            const name = path.split('/').pop();
            const tab = document.createElement('div');
            tab.className = 'tab';
            tab.dataset.path = path;
            tab.innerHTML = `<span class="icon">${getFileIcon(name)}</span><span class="name">${name}</span><span class="close" onclick="closeTab(event, '${path}')">Ã—</span>`;
            tab.onclick = () => activateTab(path);
            tabs.appendChild(tab);
        }

        function activateTab(path) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.file-item').forEach(f => f.classList.remove('active'));

            const tab = document.querySelector(`.tab[data-path="${path}"]`);
            if (tab) tab.classList.add('active');

            const fileItem = document.querySelector(`.file-item[data-path="${path}"]`);
            if (fileItem) fileItem.classList.add('active');

            const fileData = openFiles.get(path);
            if (fileData && editor) editor.setModel(fileData.model);

            activeFile = path;
            document.getElementById('fileStatus').textContent = path;
        }

        function closeTab(event, path) {
            event.stopPropagation();
            const fileData = openFiles.get(path);
            if (fileData?.modified && !confirm('ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            if (fileData?.model) fileData.model.dispose();

            openFiles.delete(path);
            document.querySelector(`.tab[data-path="${path}"]`)?.remove();

            if (activeFile === path) {
                const remainingTabs = document.querySelectorAll('.tab');
                if (remainingTabs.length > 0) {
                    activateTab(remainingTabs[0].dataset.path);
                } else {
                    activeFile = null;
                    document.getElementById('editor').innerHTML = '<div class="welcome"><h2>ğŸ§  MAEUM_CODE IDE</h2></div>';
                    editor = null;
                }
            }
        }

        function updateTab(path, modified) {
            const tab = document.querySelector(`.tab[data-path="${path}"]`);
            if (tab) tab.classList.toggle('modified', modified);
        }

        async function saveCurrentFile() {
            if (!activeFile || !editor) return;

            // ì‚¬ìš©ì í™•ì¸
            const confirmed = confirm(`íŒŒì¼ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nğŸ“ ${activeFile}`);
            if (!confirmed) {
                addOutput('âš ï¸ ì €ì¥ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
                return;
            }

            try {
                await fetch('/api/file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: activeFile, content: editor.getValue() })
                });
                const fileData = openFiles.get(activeFile);
                if (fileData) {
                    fileData.originalContent = editor.getValue();
                    fileData.modified = false;
                    updateTab(activeFile, false);
                }
                addOutput('âœ… ì €ì¥ë¨: ' + activeFile);
            } catch (error) {
                alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            }
        }

        function refreshFiles() { loadFiles(''); }

        async function createFile() {
            const name = prompt('ìƒˆ íŒŒì¼ ì´ë¦„:');
            if (!name) return;

            // ì‚¬ìš©ì í™•ì¸
            const confirmed = confirm(`íŒŒì¼ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nğŸ“„ ${name}`);
            if (!confirmed) {
                addOutput('âš ï¸ íŒŒì¼ ìƒì„±ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
                return;
            }

            try {
                await fetch('/api/file/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: name, content: '', is_directory: false })
                });
                addOutput('âœ… íŒŒì¼ ìƒì„±ë¨: ' + name);
                refreshFiles();
                openFile(name);
            } catch (error) {
                addOutput('âŒ íŒŒì¼ ìƒì„± ì‹¤íŒ¨: ' + error.message);
            }
        }

        async function createFolder() {
            const name = prompt('ìƒˆ í´ë” ì´ë¦„:');
            if (!name) return;

            // ì‚¬ìš©ì í™•ì¸
            const confirmed = confirm(`í´ë”ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nğŸ“ ${name}`);
            if (!confirmed) {
                addOutput('âš ï¸ í´ë” ìƒì„±ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
                return;
            }

            try {
                await fetch('/api/file/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: name, is_directory: true })
                });
                addOutput('âœ… í´ë” ìƒì„±ë¨: ' + name);
                refreshFiles();
            } catch (error) {
                addOutput('âŒ í´ë” ìƒì„± ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ============================================================
        // Undo/Redo (ì‚¬ìš©ì í™•ì¸ í›„ ì‹¤í–‰)
        // ============================================================
        async function performUndo() {
            try {
                // 1. ë¨¼ì € ë¯¸ë¦¬ë³´ê¸° ìš”ì²­
                const previewResp = await fetch('/api/undo?confirm=false', { method: 'POST' });
                const preview = await previewResp.json();

                if (!preview.success) {
                    addOutput('âš ï¸ ' + (preview.message || 'ì‹¤í–‰ ì·¨ì†Œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤'));
                    return;
                }

                // 2. ì‚¬ìš©ìì—ê²Œ í™•ì¸ ìš”ì²­
                const tx = preview.transaction;
                const filesList = tx.files.join(', ');
                const confirmed = confirm(
                    `ì‹¤í–‰ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
                    `ğŸ“ ${tx.description}\n` +
                    `ğŸ“ íŒŒì¼: ${filesList}\n` +
                    `ğŸ• ì‹œê°„: ${new Date(tx.timestamp).toLocaleString()}`
                );

                if (!confirmed) {
                    addOutput('âš ï¸ ì‹¤í–‰ ì·¨ì†Œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
                    return;
                }

                // 3. ì‹¤ì œ ì‹¤í–‰
                const response = await fetch('/api/undo?confirm=true', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    addOutput('â†©ï¸ ' + result.message);
                    refreshFiles();
                    // í˜„ì¬ ì—´ë¦° íŒŒì¼ ìƒˆë¡œê³ ì¹¨
                    await refreshOpenFiles();
                } else {
                    addOutput('âš ï¸ ' + (result.message || 'ì‹¤í–‰ ì·¨ì†Œ ì‹¤íŒ¨'));
                }
            } catch (error) {
                addOutput('âŒ Undo ì˜¤ë¥˜: ' + error.message);
            }
        }

        async function performRedo() {
            try {
                // 1. ë¨¼ì € ë¯¸ë¦¬ë³´ê¸° ìš”ì²­
                const previewResp = await fetch('/api/redo?confirm=false', { method: 'POST' });
                const preview = await previewResp.json();

                if (!preview.success) {
                    addOutput('âš ï¸ ' + (preview.message || 'ë‹¤ì‹œ ì‹¤í–‰í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤'));
                    return;
                }

                // 2. ì‚¬ìš©ìì—ê²Œ í™•ì¸ ìš”ì²­
                const tx = preview.transaction;
                const filesList = tx.files.join(', ');
                const confirmed = confirm(
                    `ë‹¤ì‹œ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
                    `ğŸ“ ${tx.description}\n` +
                    `ğŸ“ íŒŒì¼: ${filesList}\n` +
                    `ğŸ• ì‹œê°„: ${new Date(tx.timestamp).toLocaleString()}`
                );

                if (!confirmed) {
                    addOutput('âš ï¸ ë‹¤ì‹œ ì‹¤í–‰ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
                    return;
                }

                // 3. ì‹¤ì œ ì‹¤í–‰
                const response = await fetch('/api/redo?confirm=true', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    addOutput('â†ªï¸ ' + result.message);
                    refreshFiles();
                    await refreshOpenFiles();
                } else {
                    addOutput('âš ï¸ ' + (result.message || 'ë‹¤ì‹œ ì‹¤í–‰ ì‹¤íŒ¨'));
                }
            } catch (error) {
                addOutput('âŒ Redo ì˜¤ë¥˜: ' + error.message);
            }
        }

        async function refreshOpenFiles() {
            // í˜„ì¬ ì—´ë¦° ëª¨ë“  íŒŒì¼ ìƒˆë¡œê³ ì¹¨
            for (const [path, fileData] of openFiles) {
                try {
                    const resp = await fetch(`/api/file?path=${encodeURIComponent(path)}`);
                    const data = await resp.json();
                    if (!data.is_binary && data.content !== undefined) {
                        if (editor && activeFile === path) {
                            editor.setValue(data.content);
                        }
                        fileData.originalContent = data.content;
                        fileData.modified = false;
                        updateTab(path, false);
                    }
                } catch (e) {
                    // íŒŒì¼ì´ ì‚­ì œëœ ê²½ìš°
                    closeTab({ stopPropagation: () => {} }, path);
                }
            }
        }

        async function refreshIndex() {
            try {
                addOutput('ğŸ” ì¸ë±ìŠ¤ ê°±ì‹  ì¤‘...');
                const response = await fetch('/api/index/refresh', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    addOutput('âœ… ì¸ë±ìŠ¤ ê°±ì‹  ì™„ë£Œ');
                }
            } catch (error) {
                addOutput('âŒ ì¸ë±ìŠ¤ ì˜¤ë¥˜: ' + error.message);
            }
        }

        async function getHistory() {
            try {
                const response = await fetch('/api/history');
                const result = await response.json();
                return result.history || [];
            } catch (error) {
                console.error('History error:', error);
                return [];
            }
        }

        // ============================================================
        // Context Menu
        // ============================================================
        function showContextMenu(event, path, isDirectory) {
            const menu = document.getElementById('contextMenu');
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.classList.add('show');
            contextMenuTarget = { path, isDirectory };
        }

        document.onclick = () => document.getElementById('contextMenu').classList.remove('show');

        async function renameItem() {
            if (!contextMenuTarget) return;

            const oldPath = contextMenuTarget.path;
            const oldName = oldPath.split('/').pop();
            const newName = prompt('ìƒˆ ì´ë¦„:', oldName);
            if (!newName || newName === oldName) return;

            const newPath = oldPath.split('/').slice(0, -1).concat(newName).join('/') || newName;

            // ì‚¬ìš©ì í™•ì¸
            const confirmed = confirm(
                `ì´ë¦„ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
                `ğŸ“ ì´ì „: ${oldPath}\n` +
                `ğŸ“ ì´í›„: ${newPath}`
            );
            if (!confirmed) {
                addOutput('âš ï¸ ì´ë¦„ ë³€ê²½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
                return;
            }

            try {
                const response = await fetch('/api/file/rename', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ old_path: oldPath, new_path: newPath })
                });

                if (response.ok) {
                    addOutput(`âœï¸ ì´ë¦„ ë³€ê²½ë¨: ${oldPath} â†’ ${newPath}`);
                    refreshFiles();

                    // ì—´ë¦° íƒ­ ì—…ë°ì´íŠ¸
                    if (openFiles.has(oldPath)) {
                        const fileData = openFiles.get(oldPath);
                        openFiles.delete(oldPath);
                        openFiles.set(newPath, fileData);

                        const tab = document.querySelector(`.tab[data-path="${oldPath}"]`);
                        if (tab) {
                            tab.dataset.path = newPath;
                            tab.querySelector('.name').textContent = newName;
                        }

                        if (activeFile === oldPath) {
                            activeFile = newPath;
                            document.getElementById('fileStatus').textContent = newPath;
                        }
                    }
                } else {
                    const result = await response.json();
                    addOutput(`âŒ ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨: ${result.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                addOutput(`âŒ ì´ë¦„ ë³€ê²½ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        async function deleteItem() {
            if (!contextMenuTarget) return;

            const path = contextMenuTarget.path;
            const isDir = contextMenuTarget.isDirectory;
            const typeStr = isDir ? 'í´ë”' : 'íŒŒì¼';

            // 1ì°¨ í™•ì¸
            const firstConfirm = confirm(
                `âš ï¸ ${typeStr}ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
                `${isDir ? 'ğŸ“' : 'ğŸ“„'} ${path}\n\n` +
                `ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (Undo).`
            );
            if (!firstConfirm) {
                addOutput('âš ï¸ ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
                return;
            }

            // 2ì°¨ í™•ì¸ (ë”ë¸” ì²´í¬)
            const secondConfirm = confirm(
                `ğŸš¨ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
                `${isDir ? 'ğŸ“' : 'ğŸ“„'} ${path}\n\n` +
                `[í™•ì¸]ì„ ëˆ„ë¥´ë©´ ${typeStr}ê°€ ì‚­ì œë©ë‹ˆë‹¤.`
            );
            if (!secondConfirm) {
                addOutput('âš ï¸ ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤ (2ì°¨ í™•ì¸)');
                return;
            }

            try {
                const response = await fetch(`/api/file?path=${encodeURIComponent(path)}`, { method: 'DELETE' });
                const result = await response.json();

                if (response.ok) {
                    addOutput(`ğŸ—‘ï¸ ì‚­ì œë¨: ${path}`);
                    refreshFiles();

                    // ì—´ë¦° íƒ­ì´ë©´ ë‹«ê¸°
                    if (openFiles.has(path)) {
                        closeTab({ stopPropagation: () => {} }, path);
                    }
                } else {
                    addOutput(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${result.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                addOutput(`âŒ ì‚­ì œ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        function copyPath() {
            if (contextMenuTarget) navigator.clipboard.writeText(contextMenuTarget.path);
        }

        // ============================================================
        // Search
        // ============================================================
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&mode=content`);
            const data = await response.json();
            const results = document.getElementById('searchResults');

            results.innerHTML = data.results.length === 0
                ? '<p style="color: var(--text-secondary);">ê²°ê³¼ ì—†ìŒ</p>'
                : data.results.map(r => `
                    <div class="search-result" onclick="openFileAtLine('${r.file}', ${r.line})">
                        <span class="file">${r.file}</span><span class="line">:${r.line}</span>
                    </div>
                `).join('');
        }

        function openFileAtLine(file, line) {
            openFile(file);
            setTimeout(() => {
                if (editor && line) {
                    editor.revealLineInCenter(line);
                    editor.setPosition({ lineNumber: line, column: 1 });
                }
            }, 100);
        }

        // ============================================================
        // Panel Switching
        // ============================================================
        document.querySelectorAll('.panel-tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const panelId = tab.dataset.panel;
                document.getElementById('aiPanel').style.display = panelId === 'ai' ? '' : 'none';
                document.getElementById('searchPanel').style.display = panelId === 'search' ? '' : 'none';
                document.getElementById('outputPanel').style.display = panelId === 'output' ? '' : 'none';
            };
        });

        // ============================================================
        // Utilities
        // ============================================================
        async function checkAIStatus() {
            try {
                const response = await fetch('/api/ai/status');
                const data = await response.json();
                document.getElementById('aiStatus').textContent = data.available ? 'ğŸ¤– AI ì˜¨ë¼ì¸' : 'ğŸ¤– AI ì˜¤í”„ë¼ì¸';
            } catch (error) {
                document.getElementById('aiStatus').textContent = 'ğŸ¤– ìƒíƒœ í™•ì¸ ì‹¤íŒ¨';
            }
        }

        function addOutput(text) {
            const output = document.getElementById('outputContent');
            output.textContent += `[${new Date().toLocaleTimeString()}] ${text}\n`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Resize handle
        const resizeHandle = document.getElementById('resizeHandle');
        let isResizing = false;

        resizeHandle.onmousedown = () => { isResizing = true; document.body.style.cursor = 'ns-resize'; };
        document.onmousemove = (e) => {
            if (!isResizing) return;
            const container = document.querySelector('.main');
            const newHeight = container.getBoundingClientRect().bottom - e.clientY;
            if (newHeight >= 150 && newHeight <= 600) {
                document.getElementById('bottomPanel').style.height = newHeight + 'px';
                if (editor) editor.layout();
            }
        };
        document.onmouseup = () => { isResizing = false; document.body.style.cursor = ''; };

        window.onresize = () => { if (editor) editor.layout(); };
    </script>
</body>
</html>
